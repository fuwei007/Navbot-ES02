#include "SlotCalibration.h" 

float Motor1_Current_sp_data[TorqueSamples]= {
                                              -0.008083,-0.008175,-0.005452,-0.002661,-0.001120,0.000860,0.001384,0.001703,0.002480,0.001444,0.003094,0.004014,0.004051,0.003817,-0.003012,-0.001611,-0.011996,-0.010096,-0.011957,-0.010450,-0.008491,-0.004868,0.000050,0.003074,0.004359,0.004622,0.000941,0.003090,0.004908,0.002786,0.003512,0.004309,0.000847,0.000821,0.001844,0.004191,0.001193,0.004658,0.008907,0.011860,0.014082,0.015999,0.008267,0.010345,0.005106,0.007190,0.004365,0.008284,0.008623,0.008750,0.007646,0.004085,0.006292,0.007143,0.008862,0.010686,0.012864,0.013096,0.006690,0.007719,0.000064,0.000589,-0.000522,0.000449,0.000675,0.001879,0.003277,0.003710,0.003891,0.003938,0.006482,0.004256,0.004245,0.007692,0.007905,0.000047,0.001480,-0.007264,-0.005877,-0.008433,-0.006936,-0.005433,-0.003154,-0.000919,-0.000285,0.000617,0.000715,0.001196,0.002742,0.004986,0.007801,0.009069,0.009060,0.003825,0.005976,0.002910,0.004277,0.004907,0.006386,0.007926,0.008462,0.005866,0.006143,0.000354,-0.000537,0.001938,0.001618,0.005757,0.007641,0.008733,0.009125,0.009927,0.010063,0.010267,0.011559,0.012795,0.015315,0.008579,0.010946,-0.003149,0.000782,0.001404,0.002120,0.002422,0.004567,0.007077,0.008872,0.009764,0.008852,0.008452,0.004208,0.007497,0.007597,0.006693,0.005214,-0.006803,-0.003896,-0.003044,-0.009971,-0.005972,-0.005141,-0.000615,0.003415,0.005976,0.006990,0.007123,0.002683,0.004026,0.003803,0.005050,0.005439,0.004810,-0.000859,0.001332,-0.004564,-0.001991,-0.001178,0.000418,0.004160,0.007399,0.009394,0.010116,0.009381,0.006800,0.007687,0.007707,0.007627,0.008427,0.010201,0.011184,0.011600,0.011881,0.012697,0.013004,0.015430,0.018086,0.020010,0.020188,0.011424,0.014560,0.002853,0.004873,0.004079,0.000807,0.002345,0.004550,0.005468,0.005952,0.006785,0.005408,0.005046,0.007008,0.008882,0.009710,0.008121,0.002228,0.004538,-0.008107,-0.004246,-0.004936,-0.009028,-0.005431,-0.002900,-0.001048,-0.000922,-0.005965,-0.002027,-0.002014,-0.005012,-0.000334,0.002953,0.005012,0.005454,0.005513,-0.000364,0.004088,0.004560,0.005624,0.007704,0.011026,0.012768,0.013349,0.012660,0.011648,0.004550,0.009435,0.009536,0.011557,0.013897,0.016625,0.017940,0.018098,0.019866,0.017223,0.013714,0.017727,0.018775,0.018929,0.007455,0.012450,0.000345,0.007206,0.001964,0.005566,0.006778,0.007705,0.010487,0.009618,0.008027,0.010074,0.010361,0.004909,0.008816,0.001326,0.005567,-0.005562,-0.012264,-0.007838,-0.018457,-0.012872,-0.012649,-0.009988,-0.006368,-0.002099,0.001243,0.002540,0.003187,0.002076,0.004479,0.004860,0.006415,0.007100,0.007348,-0.003204,0.004931,0.004332,0.004350,0.004876,0.009517,0.013566,0.016329,0.017275,0.009171,0.014870,0.002788,0.007964,0.011214,0.011806,0.013357,0.014191,0.018177,0.015257,0.015872,0.016722,0.018351,0.020032,0.020863,0.019476,0.020343,0.000991,0.008186,0.000632,0.006272,0.006384,0.006358,0.003329,0.005588,-0.000033,0.003465,-0.003527,0.001324,0.001505,0.001803,0.003312,0.004445,0.002065,-0.009321,-0.004017,-0.012820,-0.007820,-0.010377,-0.007558,-0.004832,-0.002439,-0.001403,0.000400,0.001320,0.001604,0.002488,0.005368,0.008359,0.009904,0.010007,0.001921,0.007961,-0.000311,0.005552,0.005078,0.007396,0.010247,0.012474,0.009559,0.011413,0.001806,0.007528,0.007749,0.008801,0.011378,0.013553,0.014409,0.015400,0.014316,0.014925,0.015813,0.014878,0.017026,0.012474,0.013803,0.005766,-0.008106,-0.002518,-0.004667,-0.003791,-0.003663,-0.002036,0.001005,0.003445,0.004897,0.004906,-0.000353,0.004002,0.004136,-0.000141,0.003165,-0.002253,0.000639,-0.015149,-0.009591,-0.007706,-0.014238,-0.009222,-0.006695,-0.002130,0.002447,0.004370,0.004769,0.004950,-0.002811,0.003415,0.003727,0.004728,0.005696,0.002149,-0.000124,0.002969,-0.002402,0.002136,0.000387,0.006762,0.010859,0.012683,0.013287,0.007639,0.010612,0.001738,0.007648,0.007757,0.008629,0.009045,0.009188,0.001716,0.007324,0.005304,0.007201,0.008324,0.010449,0.012097,0.012347,0.003367,0.008702,-0.004618,0.001277,-0.004896,-0.000563,-0.000417,0.000728,0.001919,0.002145,0.003129,0.003291,0.004096,0.004189,0.004203,0.005098,0.005608,-0.000782,0.002801,-0.011107,-0.007980,-0.007945,-0.011877,-0.007814,-0.004732,-0.002811,-0.002324,-0.001500,-0.001352,-0.000764,0.000471,0.003154,0.005869,0.008015,0.008054,0.000340,0.005021,-0.000318,0.003611,0.004094,0.007008,0.009006,0.009204,0.000374,0.005824,-0.005342,0.000885,0.001166,0.001981,0.003723,0.005912,0.009063,0.009474,0.010373,0.010691,0.011262,0.012201,0.013293,0.013495,0.012416,0.006390,0.009226,-0.006074,-0.000633,-0.000385,-0.001669,0.000379,0.003226,0.007029,0.007855,0.004612,0.004091,0.006267,0.000563,0.004247,-0.000088,0.002354,-0.008944,-0.003477,-0.014163,-0.006885,-0.011397,-0.007542,-0.003996,0.000788,0.003466,0.004665,0.004872,0.002056,0.003456,0.001406,0.003686,0.003944,0.004112,-0.005901,-0.000595,-0.008905,-0.003555,-0.003535,-0.001478,0.002743,0.006545,0.009133,0.010024,0.005062,0.007744,0.002711,0.005531,0.005516,0.006793,0.008239,0.009602,0.009834,0.009983,0.010802,0.010908,0.012584,0.014504,0.016956,0.017133,0.010130,0.013543,0.002256,0.004206,0.002431,-0.000554,0.002181,0.003316,0.004316,0.004798,0.004807,0.006016,0.004046,0.005860,0.006364,0.008131,0.008234,-0.002420,0.001073,-0.007951,-0.005009,-0.010206,-0.007499,-0.006578,-0.005348,-0.003202,-0.003108,-0.006038,-0.004164,-0.006656,-0.004500,-0.002918,-0.000076,0.001887,0.002597,0.002704,-0.001049,0.001231,0.001302,0.002097,0.003984,0.007134,0.008742,0.009230,0.005017,0.006767,0.001809,0.001675,0.005027,0.006728,0.007933,0.008961,0.012847,0.013485,0.013324,0.013664,0.010380,0.014119,0.015038,0.012323,0.012897,0.002535,0.005551,0.001292,0.002005,0.003226,0.003208,0.006776,0.008412,0.008661,0.007032,0.007811,0.009311,0.006561,0.006593,0.001800,0.002439,-0.003765,-0.014163,-0.010676,-0.014695,-0.014567,-0.014366,-0.010985,-0.006682,-0.003013,-0.001167,-0.000263,-0.000131,0.000213,0.000226,0.001001,0.001552,0.002097,0.002186,-0.001170,-0.000441,-0.000556,-0.000644,0.003008,0.004435,0.007390,0.012133,0.011611,0.013555,0.010595,0.004146,0.006598,0.006751,0.006874,0.006652,0.009054,0.009270,0.010086,0.010225,0.011288,0.015655,0.015736,0.017276,0.019136,0.010140,0.009413,0.001885,0.003664,0.002925,0.002373,0.002419,0.003203,0.003276,0.003292,0.000994,-0.000769,-0.000426,-0.000194,-0.002626,0.001943,0.000157,-0.004041,-0.003140,-0.011729,-0.009411,-0.009027,-0.009923,-0.008684,-0.005784,-0.003619,-0.002493,-0.002656,-0.001082,-0.000871,0.001643,0.002562,0.005400,0.007297,0.007426,0.004315,0.005333,0.002878,0.003879,0.002065,0.006132,0.007765,0.009068,0.009164,0.005519,0.006587,0.003172,0.006157,0.006802,0.010866,0.012986,0.013903,0.014068,0.013286,0.014103,0.013595,0.014436,0.015297,0.012993,0.007910,0.008881,-0.001648
                                             };

                                             
float Motor2_Current_sp_data[TorqueSamples]= {
                                              -0.005394,-0.000058,0.001231,0.001498,-0.010884,-0.005282,-0.011865,-0.008287,-0.008236,-0.006498,-0.001389,0.004051,0.008884,0.012173,0.013789,0.014174,0.014415,0.014843,0.016533,0.018200,0.020270,0.015985,0.018936,0.003899,0.009665,0.010324,-0.001479,0.006880,0.007462,-0.001053,0.005244,-0.004504,0.001566,-0.003372,0.001586,0.003145,0.009388,0.014364,0.017697,0.012191,0.016699,0.011234,-0.007102,-0.000834,-0.000523,-0.010710,-0.005657,-0.016573,-0.011633,-0.011273,-0.011270,-0.010163,-0.006504,-0.000783,0.007520,0.014710,0.016656,0.017033,0.009169,0.013709,-0.002543,0.003527,0.003684,-0.009141,-0.003982,-0.010316,-0.006883,-0.012869,-0.007323,-0.003847,0.002886,0.011310,0.016430,0.019684,0.019998,0.020124,0.012999,0.017815,0.011713,0.016534,0.007657,0.013304,-0.003379,0.003298,0.003627,-0.004300,0.001937,0.002672,0.005981,0.006880,0.007298,0.007485,0.007445,0.006544,0.008451,0.011109,0.014516,0.017090,0.018719,0.012178,0.016130,-0.004841,0.002822,-0.003234,0.001356,-0.005018,-0.000536,-0.013332,-0.006172,-0.010297,-0.007137,-0.006235,-0.003553,0.002366,0.008109,0.012403,0.013797,0.009353,0.012607,-0.000500,0.008198,0.001081,0.006288,-0.008792,-0.001017,-0.011590,-0.004613,-0.012403,-0.008178,-0.004353,0.002741,0.008317,0.011058,0.011252,0.008430,0.011227,0.004813,0.010061,0.011243,0.013258,0.015141,0.015208,0.003184,0.009849,0.002062,0.008114,0.001332,0.006978,0.007353,0.007428,0.001605,0.006209,0.000482,0.006253,0.007068,0.010874,0.015820,0.020035,0.021976,0.014028,0.018828,0.004433,-0.001454,0.001606,-0.010250,-0.005373,-0.006590,-0.012175,-0.012624,-0.016491,-0.012398,-0.010645,-0.006126,0.000808,0.006935,0.013213,0.015546,0.010468,0.013386,0.002056,0.005906,-0.002291,0.000755,-0.013153,-0.009916,-0.015253,-0.013357,-0.018492,-0.014843,-0.011732,-0.007104,0.001007,0.008018,0.012483,0.014469,0.015083,0.015370,0.013660,0.014562,0.014794,0.014565,0.013629,0.004397,0.007848,0.002219,0.005339,0.005252,0.005929,0.009085,0.010361,0.010559,0.008605,0.009422,0.005664,0.008075,0.006788,0.010886,0.013702,0.015539,0.015714,0.006463,0.008932,0.000445,0.001047,-0.001855,-0.004137,-0.004484,-0.004308,-0.014539,-0.010280,-0.010161,-0.007806,-0.008079,-0.003928,-0.000439,0.005780,0.007549,0.007008,0.003174,0.004435,-0.004399,-0.001059,-0.002021,-0.001937,-0.011280,-0.007622,-0.015707,-0.010395,-0.010028,-0.007319,-0.002165,0.003380,0.008239,0.011306,0.012870,0.013082,0.013075,0.013792,0.014175,0.016243,0.018090,0.016962,0.009205,0.013888,0.004650,0.007995,0.005377,0.006184,0.007007,0.004447,0.005875,0.003935,0.005386,0.005565,0.007223,0.010657,0.014907,0.018824,0.020966,0.015634,0.017001,0.010829,0.001233,0.002188,-0.009495,-0.005825,-0.009989,-0.010643,-0.021152,-0.018418,-0.018191,-0.016574,-0.011871,-0.004245,0.002626,0.008781,0.010521,0.011943,0.008081,0.006351,0.000002,0.001523,-0.007486,-0.002320,-0.011827,-0.009565,-0.012139,-0.010463,-0.008961,-0.004332,0.001739,0.010763,0.016690,0.018967,0.020013,0.020171,0.014069,0.017231,0.015421,0.015958,0.012624,0.010705,0.011689,0.003406,0.007431,0.006919,0.006927,0.008466,0.011573,0.011797,0.010502,0.010532,0.005627,0.007964,0.012499,0.010843,0.013022,0.015263,0.015558,0.004612,0.006256,-0.001551,-0.000880,-0.005373,-0.003572,-0.008860,-0.006328,-0.014294,-0.013607,-0.011928,-0.009623,-0.010723,-0.006487,-0.003565,0.004624,0.007473,0.010911,0.013297,0.010135,0.004008,0.006306,0.004480,0.001860,-0.000342,-0.000582,-0.010639,-0.006605,-0.007038,-0.005650,-0.006004,-0.001497,0.006133,0.008663,0.012765,0.013692,0.014108,0.014377,0.014893,0.016589,0.018750,0.019513,0.014045,0.015590,0.005048,0.004470,0.007933,0.006191,0.006180,0.004627,0.002294,0.003567,0.003172,0.000670,0.000684,0.001138,0.005908,0.009372,0.015402,0.016461,0.014929,0.009482,0.010152,-0.004143,-0.001292,-0.002916,-0.007362,-0.006221,-0.015090,-0.013727,-0.011806,-0.011012,-0.010539,-0.007350,-0.000482,0.009839,0.013750,0.017339,0.012257,0.015876,-0.000839,0.001822,0.000731,-0.002561,-0.010049,-0.009604,-0.012121,-0.010910,-0.010810,-0.010565,-0.005636,0.003646,0.007895,0.013267,0.016853,0.017167,0.016487,0.014995,0.014053,0.013348,0.013333,0.006087,0.008265,-0.001149,0.000808,-0.001164,-0.000425,0.000358,0.001910,0.003991,0.004994,0.005223,0.005303,0.005269,0.005983,0.007272,0.008458,0.013936,0.014873,0.016265,0.004946,0.010847,-0.000796,0.003898,-0.000876,-0.002051,-0.005850,-0.002456,-0.009281,-0.008430,-0.013536,-0.010108,-0.008224,-0.005406,0.001965,0.005911,0.009723,0.011128,0.007684,0.009953,0.002323,0.005133,0.000762,0.002481,-0.007874,-0.005263,-0.009414,-0.008534,-0.008475,-0.008343,-0.003511,0.001001,0.003476,0.011302,0.009015,0.005663,0.007312,0.007954,0.007390,0.009355,0.008669,0.012671,0.014347,0.006774,0.008212,0.004381,0.004412,0.006424,0.003420,0.004772,0.004845,0.001071,-0.000487,0.002570,0.003407,0.005408,0.009614,0.014204,0.016904,0.019923,0.013751,0.015780,0.007789,-0.004863,-0.005038,-0.002656,-0.006888,-0.007955,-0.012507,-0.012233,-0.015191,-0.013296,-0.011529,-0.005468,0.002747,0.008780,0.013269,0.015049,0.010467,0.012477,-0.000009,0.002896,-0.001201,-0.001099,-0.013966,-0.009600,-0.018913,-0.016614,-0.018619,-0.016734,-0.013357,-0.006570,0.000174,0.006759,0.011560,0.011041,0.013221,0.013385,0.011805,0.015160,0.012848,0.012939,0.007785,0.009866,0.005342,0.004619,0.002773,0.003214,0.004666,0.007247,0.009416,0.009803,0.008100,0.006766,0.007953,0.007941,0.008729,0.011091,0.013897,0.015721,0.015728,0.010113,0.009863,-0.000716,0.002551,0.003014,0.000066,-0.008715,-0.006289,-0.012640,-0.010489,-0.011832,-0.011330,-0.009176,-0.006544,0.000520,0.005182,0.006162,0.006668,0.004730,0.003707,-0.005474,-0.004688,-0.000511,-0.002638,-0.012088,-0.010655,-0.013036,-0.012089,-0.011857,-0.010678,-0.003982,0.000202,0.005871,0.009463,0.011482,0.012187,0.012234,0.010983,0.012674,0.015684,0.017414,0.017847,0.012132,0.013887,0.004704,0.005812,0.006065,0.005846,0.005116,0.005356,0.003117,0.004145,0.004164,0.002901,0.004746,0.008071,0.012819,0.017850,0.020680,0.018701,0.014244,0.011366,0.004069,-0.002224,-0.000840,-0.011455,-0.009027,-0.017349,-0.014759,-0.020060,-0.018664,-0.017738,-0.014697,-0.009157,-0.003524,0.005802,0.008934,0.010862,0.006984,0.008059,-0.000863,0.001472,-0.001398,-0.002674,-0.008925,-0.009528,-0.013220,-0.011639,-0.011775,-0.007786,-0.002313,0.004092,0.014148,0.014930,0.018394,0.018640,0.015930,0.016502,0.012870,0.014660,0.014676,0.010075,0.011508,0.003173,0.007761,0.005790,0.005800,0.006785,0.009236,0.010717,0.009285,0.009390,0.004708,0.006964,0.007248,0.008353,0.011109,0.013943,0.014943,0.005424,0.009075,0.000269,0.002317,-0.005518,-0.004357,-0.006497,-0.007609,-0.015361,-0.012023,-0.016873,-0.014126,-0.011971,-0.009803,-0.004599,0.005551,0.006043,0.009521,0.010018,0.005508,0.007944                                             
                                             };

float Current_sp_data[TorqueSamples]= {0};
                                                                            
float input_pos = 0; // Target position
int Current_sp_data_index = 0; // Index
float pos_err = 0; // Position error
int Slot_calibration_mark = 0; // Calibration completion flag

void CalibrationCurrentSp(float Position_estimation,float Velocity_estimation,BLDCMotor *Motor)
{
  pos_err =  input_pos - Position_estimation; // Target value minus measured value

  if( (fabs(pos_err) <= SlotPositionErrorLimit) && (fabs(Velocity_estimation)<=SlotVelocityLimit) ) // Collect data
  {
    Current_sp_data[Current_sp_data_index] = Motor->current_sp; //
    Serial.print(Current_sp_data_index); 
    Serial.print("\t");     
    Serial.print("current_sp:"); 
    Serial.println(Current_sp_data[Current_sp_data_index],6);
    Current_sp_data_index++;
  }
  else
  {
    
    Serial.print(" index:"); 
    Serial.print(Current_sp_data_index); 
    Serial.print(" t:"); 
    Serial.print(input_pos,6); 
    Serial.print(" c:"); 
    Serial.print(Position_estimation,6); 
    Serial.print(" e:"); 
    Serial.print(pos_err,6); 
    Serial.print(" vdex:"); 
    Serial.println(Velocity_estimation,6);   
    
  }
  
  if(Current_sp_data_index < TorqueSamples) // Update position
  {
    input_pos = Current_sp_data_index * AngleResolutionRatio; // Target angle
    Motor->target = input_pos;
    
    
  }
  else // Sampling completed
  {
    Slot_calibration_mark = 1; // Calibration completed
    Serial.println(" ");
    Serial.println("current_sp ok"); 
    for(int i=0;i<TorqueSamples;i++)
    {
      Serial.print(Current_sp_data[i],6);
      Serial.print(",");
    }  
    Serial.println(" ");
    Serial.println(" OK");

    
  }
  
}
